<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="../static/images/favicon.ico" type="image/x-icon">
    <title>DCCMS - Scheduled Events</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="../static/styles/judge/events.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <style>
        .status-scheduled {
            color: blue;
        }

        .status-finished {
            color: green;
        }

        .pagination-controls {
            text-align: center;
            margin-top: 20px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
            padding-top: 60px;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
        }
    </style>
</head>
<body>
    {% include 'index_judge.html' %}
    <div class="container">
        <h1 class="my-4">Scheduled Events</h1>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="events-table-body">
                <!-- Events will be inserted here by JavaScript -->
            </tbody>
        </table>

        <div id="editEventModal" class="modal">
            <div class="modal-content">
                <h2>Edit Event</h2>
                <label for="editEventTitle">Event Title:</label>
                <input type="text" id="editEventTitle" placeholder="Enter event title"><br><br>
                
                <label for="editEventDate">Event Date:</label>
                <input type="date" id="editEventDate"><br><br>
                
                <label for="editEventTime">Event Time:</label>
                <select id="editEventHour">
                    <option value="" disabled selected>Hour</option>
                    <script>
                        for (let i = 0; i < 24; i++) {
                            document.write('<option value="' + (i < 10 ? '0' : '') + i + '">' + (i < 10 ? '0' : '') + i + '</option>');
                        }
                    </script>
                </select>
                <select id="editEventMinute">
                    <option value="" disabled selected>Minute</option>
                    <script>
                        for (let i = 0; i < 60; i += 5) {
                            document.write('<option value="' + (i < 10 ? '0' : '') + i + '">' + (i < 10 ? '0' : '') + i + '</option>');
                        }
                    </script>
                </select><br><br>

                <div class="modal-buttons">
                    <button class="btn btn-success" id="saveEditEventBtn">Save Changes</button>
                    <button class="btn btn-secondary" id="closeEditModalBtn">Cancel</button>
                </div>
            </div>
        </div>

        <div class="pagination-controls">
            <button id="prev-btn" class="btn btn-primary" disabled>Previous</button>
            <span id="page-info"></span>
            <button id="next-btn" class="btn btn-primary">Next</button>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            const rowsPerPage = 8; 
            let currentPage = 1;
            let totalRows = 0;
            let eventsData = [];

            function loadEvents() {
                $.ajax({
                    url: '/judge/api/events',
                    method: 'GET',
                    success: function(events) {
                        eventsData = events; 
                        totalRows = events.length;
                        updateTable();
                        updatePaginationControls();
                    },
                    error: function() {
                        alert('Failed to load events.');
                    }
                });
            }

            function updateTable() {
                var tableBody = $('#events-table-body');
                tableBody.empty(); 

                const start = (currentPage - 1) * rowsPerPage;
                const end = Math.min(start + rowsPerPage, totalRows);

                for (let i = start; i < end; i++) {
                    const event = eventsData[i];
                    var eventDate = new Date(event.event_date).toDateString();
                    var eventTime = event.event_time.split(':').slice(0, 2).join(':'); 
                    var statusClass = event.status === 'finished' ? 'status-finished' : 'status-scheduled';
                    var row = '<tr>' +
                        '<td>' + event.title + '</td>' +
                        '<td>' + eventDate + '</td>' +
                        '<td>' + eventTime + '</td>' +
                        '<td class="' + statusClass + '">' + event.status + '</td>' +
                        '<td>';

                    if (event.status !== 'finished') {
                        row += '<button class="btn btn-success btn-sm finish-btn" data-id="' + event.id + '">Finish</button> ';
                        row += '<button class="btn btn-primary btn-sm edit-btn" data-id="' + event.id + '">Edit</button> ';
                    }

                    row += '<button class="btn btn-danger btn-sm delete-btn" data-id="' + event.id + '">Delete</button>' +
                        '</td>' +
                        '</tr>';
                    tableBody.append(row);
                }
            }

            function updatePaginationControls() {
                const totalPages = Math.ceil(totalRows / rowsPerPage);
                $('#page-info').text(`Page ${currentPage} of ${totalPages}`);

                $('#prev-btn').prop('disabled', currentPage === 1);
                $('#next-btn').prop('disabled', currentPage === totalPages);
            }

            loadEvents();

            $('#next-btn').on('click', function() {
                if ((currentPage * rowsPerPage) < totalRows) {
                    currentPage++;
                    updateTable();
                    updatePaginationControls();
                }
            });

            $('#prev-btn').on('click', function() {
                if (currentPage > 1) {
                    currentPage--;
                    updateTable();
                    updatePaginationControls();
                }
            });

            $(document).on('click', '.finish-btn', function() {
            var eventId = $(this).data('id');

            // Show a confirmation prompt
            var isConfirmed = confirm('Are you sure you want to mark this event as finished?');

            if (isConfirmed) {
                // If the user clicks "Yes" (OK), proceed to finish the event
                $.ajax({
                    url: '/judge/api/events/' + eventId,
                    method: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify({ status: 'finished' }),
                    success: function() {
                        loadEvents();  
                    },
                    error: function() {
                        alert('Failed to finish the event.');
                    }
                });
            }
           
        });


            $(document).on('click', '.edit-btn', function() {
                var eventId = $(this).data('id');
                var event = eventsData.find(e => e.id === eventId);
                
                $('#editEventTitle').val(event.title);
                $('#editEventDate').val(event.event_date.substring(0, 10));
                var [hours, minutes] = event.event_time.split(':').slice(0, 2);
                $('#editEventHour').val(hours);
                $('#editEventMinute').val(minutes);

                $('#editEventModal').show();
            });

            $('#saveEditEventBtn').on('click', function() {
                var title = $('#editEventTitle').val();
                var date = $('#editEventDate').val();
                var hour = $('#editEventHour').val();
                var minute = $('#editEventMinute').val();

                var updatedEvent = {
                    title: title,
                    event_date: date,
                    event_time: hour + ':' + minute,
                    status: 'scheduled'
                };

                var eventId = eventsData.find(e => e.title === title).id;

                $.ajax({
                    url: '/judge/api/events/' + eventId,
                    method: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify(updatedEvent),
                    success: function() {
                        $('#editEventModal').hide();
                        loadEvents();
                    },
                    error: function() {
                        alert('Failed to save changes to the event.');
                    }
                });
            });

            $('#closeEditModalBtn').on('click', function() {
                $('#editEventModal').hide();
            });

            $(window).on('click', function(event) {
                if (event.target == document.getElementById('editEventModal')) {
                    $('#editEventModal').hide();
                }
            });

            $(document).on('click', '.delete-btn', function() {
                var eventId = $(this).data('id');
                if (confirm('Are you sure you want to delete this event?')) {
                    $.ajax({
                        url: '/judge/api/events/' + eventId,
                        method: 'DELETE',
                        success: function() {
                            loadEvents();
                        },
                        error: function() {
                            alert('Failed to delete the event.');
                        }
                    });
                }
            });
        });

    $(document).on('click', '.delete-btn', function() {
    var eventId = $(this).data('id');
    
    var isConfirmed = confirm('Are you sure you want to delete this row?');

    if (isConfirmed) {
        $(this).closest('tr').remove();
                eventsData = eventsData.filter(event => event.id !== eventId);
                totalRows = eventsData.length;
        updatePaginationControls();
        updateTable();
    } 
});

    </script>
</body>
</html>
